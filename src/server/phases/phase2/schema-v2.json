{
  "type": "json_schema",
  "schema": {
    "type": "object",
    "properties": {
      "nftStateTypes": {
        "type": "array",
        "description": "Explicit NFT commitment layouts - the states in our state machine",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "State type name, e.g., VoterState, LoanState" },
            "derivedFrom": { "type": "string", "description": "Which Phase 1 entity this represents" },
            "fields": {
              "type": "array",
              "description": "Field definitions for NFT commitment layout",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string", "description": "Field name for CashScript variable" },
                  "type": { "type": "string", "description": "CashScript type: bytes1, bytes2, bytes4, bytes8, bytes20, bytes32" },
                  "purpose": { "type": "string", "description": "What this field stores" }
                },
                "required": ["name", "type", "purpose"],
                "additionalProperties": false
              }
            },
            "totalBytes": { "type": "integer", "description": "Sum of field bytes, must be <= 128" },
            "transitions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "State transitions, e.g., 'vote (hasVoted: 0x00 → 0x01)'"
            }
          },
          "required": ["name", "derivedFrom", "fields", "totalBytes"],
          "additionalProperties": false
        }
      },
      "transactionTemplates": {
        "type": "array",
        "description": "PRIMARY: The transactions the system supports - contracts are derived from these",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "Transaction name, e.g., castVote, repayLoan" },
            "purpose": { "type": "string" },
            "inputs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "index": { "type": "integer" },
                  "from": { "type": "string", "description": "Format: 'ContractName.functionName' or 'P2PKH'. Examples: 'Ballot.recordVote', 'Voter.vote', 'P2PKH'" },
                  "utxoType": { "type": "string", "description": "UTXO contents. MUST end with token type suffix: '{description} NFT' for non-fungible, '{description} FT' for fungible, or 'BCH only' for satoshis. Examples: 'PoolState NFT', 'liquidity tokens FT', 'BCH only'" },
                  "stateRequired": { "type": "string", "description": "Required state condition, or empty string if none" },
                  "validates": { "type": "string", "description": "Comma-separated validation requirements, or empty string for P2PKH" }
                },
                "required": ["index", "from", "utxoType"],
                "additionalProperties": false
              }
            },
            "outputs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "index": { "type": "integer" },
                  "to": { "type": "string", "description": "Format: 'ContractName.functionName', 'P2PKH', or 'burned'. Examples: 'Ballot.recordVote', 'P2PKH'" },
                  "utxoType": { "type": "string", "description": "UTXO contents. MUST end with token type suffix: '{description} NFT', '{description} FT', or 'BCH only'" },
                  "stateProduced": { "type": "string", "description": "New state after transition, or empty string if none" },
                  "covenantChecklist": { "type": "string", "description": "5-point covenant: locking|category|value|tokenAmount|commitment, or empty string" }
                },
                "required": ["index", "to", "utxoType"],
                "additionalProperties": false
              }
            }
          },
          "required": ["name", "purpose", "inputs", "outputs"],
          "additionalProperties": false
        }
      },
      "contracts": {
        "type": "array",
        "description": "DERIVED: Contracts emerge from transaction validation needs",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "Contract name (e.g., Voter, LoanSidecar, RepayFunc)" },
            "role": {
              "type": "string",
              "enum": ["container", "sidecar", "function", "minting", "independent"],
              "description": "Contract's role in the system"
            },
            "lifecycle": {
              "type": "string",
              "enum": ["exactly-replicating", "state-mutating", "state-and-balance-mutating", "conditionally-replicating"],
              "description": "How the contract's UTXO changes over time"
            },
            "nftStateType": { "type": "string", "description": "Which nftStateType this contract uses, or empty string if none" },
            "holdsBch": { "type": "boolean" },
            "holdsNft": { "type": "boolean" },
            "holdsFungible": { "type": "boolean" },
            "functions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Contract functions as strings: 'funcName @ txName [inputPos→outputPos]: validation1, validation2'"
            },
            "relationships": { "type": "string", "description": "Relationship description or empty string if none" },
            "stateLayout": { "type": "string", "description": "Human-readable state layout summary, or empty string if none" }
          },
          "required": ["name", "role", "lifecycle", "holdsBch", "holdsNft", "holdsFungible", "functions"],
          "additionalProperties": false
        }
      },
      "tokenTopology": {
        "type": "object",
        "description": "How contracts authenticate each other via token categories",
        "properties": {
          "baseCategory": { "type": "string", "description": "Symbolic name for the system's base category" },
          "typeDiscriminators": {
            "type": "array",
            "description": "First byte of nftCommitment identifies contract type (Layer 2 authentication)",
            "items": {
              "type": "object",
              "properties": {
                "discriminator": { "type": "string", "description": "Hex byte prefix, e.g., '0x00', '0x01'" },
                "contract": { "type": "string", "description": "Contract name this discriminator identifies" }
              },
              "required": ["discriminator", "contract"],
              "additionalProperties": false
            }
          },
          "capabilities": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Per-contract capability in format 'Name:capability' where capability is 'none', 'mutable', or 'minting'. Example: ['Ballot:mutable', 'Voter:mutable']"
          },
          "authentication": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Full authentication patterns using both layers: 'ContractA authenticates ContractB: category+capability AND commitment[0]==0xNN'"
          }
        },
        "required": ["baseCategory", "typeDiscriminators", "capabilities", "authentication"],
        "additionalProperties": false
      },
      "custodyDecisions": {
        "type": "array",
        "description": "Where each entity's NFT is locked",
        "items": {
          "type": "object",
          "properties": {
            "entity": { "type": "string", "description": "Entity name from Phase 1" },
            "custody": { "type": "string", "enum": ["contract", "p2pkh"], "description": "contract = locked in contract, p2pkh = user wallet" },
            "contractName": { "type": "string", "description": "Contract name if custody=contract, omit for p2pkh" },
            "rationale": { "type": "string", "description": "Why this custody was chosen" }
          },
          "required": ["entity", "custody", "rationale"],
          "additionalProperties": false
        }
      },
      "contractCountRationale": {
        "type": "object",
        "description": "Explains why this many contracts were chosen",
        "properties": {
          "total": { "type": "integer" },
          "breakdown": { "type": "string", "description": "Format: 'N containers, N sidecars, N functions, N children'" },
          "decisions": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Per-entity decisions as strings: 'Entity: N - reason'"
          }
        },
        "required": ["total", "breakdown", "decisions"],
        "additionalProperties": false
      },
      "warnings": {
        "type": "array",
        "items": { "type": "string" },
        "description": "Security warnings: 'SEVERITY: issue description - mitigation strategy'"
      }
    },
    "required": ["nftStateTypes", "transactionTemplates", "contracts", "tokenTopology", "custodyDecisions", "contractCountRationale", "warnings"],
    "additionalProperties": false
  }
}
