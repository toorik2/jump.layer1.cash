{
  "type": "json_schema",
  "schema": {
    "type": "object",
    "properties": {
      "nftStateTypes": {
        "type": "array",
        "description": "Explicit NFT commitment layouts - the states in our state machine",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "State type name, e.g., VoterState, LoanState" },
            "derivedFrom": { "type": "string", "description": "Which Phase 1 entity this represents" },
            "fields": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "type": { "type": "string", "description": "CashScript type: bytes1, bytes4, bytes8, bytes20, bytes32" },
                  "purpose": { "type": "string" }
                },
                "required": ["name", "type", "purpose"],
                "additionalProperties": false
              }
            },
            "totalBytes": { "type": "integer", "description": "Sum of field bytes, must be <= 128" },
            "transitions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "State transitions, e.g., 'vote (hasVoted: 0x00 â†’ 0x01)'"
            }
          },
          "required": ["name", "derivedFrom", "fields", "totalBytes"],
          "additionalProperties": false
        }
      },
      "transactionTemplates": {
        "type": "array",
        "description": "PRIMARY: The transactions the system supports - contracts are derived from these",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "Transaction name, e.g., castVote, repayLoan" },
            "purpose": { "type": "string" },
            "inputs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "index": { "type": "integer" },
                  "from": { "type": "string", "description": "Contract name or 'P2PKH'" },
                  "utxoType": { "type": "string", "description": "What the UTXO holds: 'BallotState NFT', 'BCH only', etc." },
                  "stateRequired": { "type": "string", "description": "Required state condition, or empty string if none" },
                  "validates": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "What this input validates about the transaction, or empty array for P2PKH"
                  }
                },
                "required": ["index", "from", "utxoType"],
                "additionalProperties": false
              }
            },
            "outputs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "index": { "type": "integer" },
                  "to": { "type": "string", "description": "Contract name, 'P2PKH', or 'burned'" },
                  "utxoType": { "type": "string" },
                  "stateProduced": { "type": "string", "description": "New state after transition, or empty string if none" },
                  "covenantChecklist": {
                    "type": "object",
                    "properties": {
                      "lockingBytecode": { "type": "string" },
                      "tokenCategory": { "type": "string" },
                      "value": { "type": "string" },
                      "tokenAmount": { "type": "string" },
                      "nftCommitment": { "type": "string" }
                    },
                    "additionalProperties": false,
                    "description": "5-point covenant checklist for self-replicating outputs, or empty object {} if not applicable"
                  }
                },
                "required": ["index", "to", "utxoType"],
                "additionalProperties": false
              }
            }
          },
          "required": ["name", "purpose", "inputs", "outputs"],
          "additionalProperties": false
        }
      },
      "contracts": {
        "type": "array",
        "description": "DERIVED: Contracts emerge from transaction validation needs",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "Contract name ending in 'Contract'" },
            "role": {
              "type": "string",
              "enum": ["container", "sidecar", "function", "minting", "independent"],
              "description": "Contract's role in the system"
            },
            "lifecycle": {
              "type": "string",
              "enum": ["exactly-replicating", "state-mutating", "state-and-balance-mutating", "conditionally-replicating"],
              "description": "How the contract's UTXO changes over time"
            },
            "nftStateType": { "type": "string", "description": "Which nftStateType this contract uses, or empty string if none" },
            "holdsBch": { "type": "boolean" },
            "holdsNft": { "type": "boolean" },
            "holdsFungible": { "type": "boolean" },
            "functions": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "transaction": { "type": "string", "description": "Which transaction template this function validates" },
                  "inputPosition": { "type": "integer" },
                  "outputPosition": { "type": "integer", "description": "Output position if self-replicating, or -1 if consumed" },
                  "validates": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "List of validation requirements"
                  }
                },
                "required": ["name", "transaction", "inputPosition", "validates"],
                "additionalProperties": false
              }
            },
            "relationships": {
              "type": "object",
              "properties": {
                "sidecarOf": { "type": "string" },
                "functionOf": { "type": "string" },
                "forTransaction": { "type": "string" },
                "identifier": { "type": "string" },
                "linkMethod": { "type": "string" },
                "hasSidecar": { "type": "string" },
                "hasFunctions": { "type": "array", "items": { "type": "string" } }
              },
              "additionalProperties": false,
              "description": "Contract relationships, or empty object {} if none"
            },
            "stateLayout": { "type": "string", "description": "Human-readable state layout summary, or empty string if none" }
          },
          "required": ["name", "role", "lifecycle", "holdsBch", "holdsNft", "holdsFungible", "functions"],
          "additionalProperties": false
        }
      },
      "tokenTopology": {
        "type": "object",
        "description": "How contracts authenticate each other via token categories",
        "properties": {
          "baseCategory": { "type": "string", "description": "Symbolic name for the system's base category" },
          "typeDiscriminators": {
            "type": "array",
            "description": "Byte prefix to contract name mappings",
            "items": {
              "type": "object",
              "properties": {
                "discriminator": { "type": "string", "description": "Byte prefix, e.g., '0x00'" },
                "contract": { "type": "string", "description": "Contract name" }
              },
              "required": ["discriminator", "contract"],
              "additionalProperties": false
            }
          },
          "capabilities": {
            "type": "array",
            "description": "Contract to NFT capability mappings",
            "items": {
              "type": "object",
              "properties": {
                "contract": { "type": "string", "description": "Contract name" },
                "capability": { "type": "string", "enum": ["none", "mutable", "minting"] }
              },
              "required": ["contract", "capability"],
              "additionalProperties": false
            }
          },
          "authentication": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "from": { "type": "string" },
                "recognizes": { "type": "string" },
                "via": { "type": "string", "description": "CashScript expression for recognition" }
              },
              "required": ["from", "recognizes", "via"],
              "additionalProperties": false
            }
          }
        },
        "required": ["baseCategory", "typeDiscriminators", "capabilities", "authentication"],
        "additionalProperties": false
      },
      "custodyDecisions": {
        "type": "array",
        "description": "Where each entity's NFT is locked",
        "items": {
          "type": "object",
          "properties": {
            "entity": { "type": "string" },
            "custody": {
              "type": "string",
              "enum": ["contract", "p2pkh"],
              "description": "contract = rules enforced, p2pkh = user has full control"
            },
            "contractName": { "type": "string", "description": "If contract custody, which contract, or empty string if p2pkh" },
            "rationale": { "type": "string" }
          },
          "required": ["entity", "custody", "rationale"],
          "additionalProperties": false
        }
      },
      "contractCountRationale": {
        "type": "object",
        "description": "Explains why this many contracts were chosen",
        "properties": {
          "total": { "type": "integer" },
          "breakdown": {
            "type": "object",
            "properties": {
              "containers": { "type": "integer" },
              "sidecars": { "type": "integer" },
              "functions": { "type": "integer" },
              "children": { "type": "integer" }
            },
            "required": ["containers", "sidecars", "functions", "children"],
            "additionalProperties": false
          },
          "decisions": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "entity": { "type": "string" },
                "contracts": { "type": "integer" },
                "reason": { "type": "string" }
              },
              "required": ["entity", "contracts", "reason"],
              "additionalProperties": false
            }
          }
        },
        "required": ["total", "breakdown", "decisions"],
        "additionalProperties": false
      },
      "warnings": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "severity": { "type": "string", "enum": ["high", "medium", "low"] },
            "issue": { "type": "string" },
            "mitigation": { "type": "string" }
          },
          "required": ["severity", "issue", "mitigation"],
          "additionalProperties": false
        }
      }
    },
    "required": ["nftStateTypes", "transactionTemplates", "contracts", "tokenTopology", "custodyDecisions", "contractCountRationale", "warnings"],
    "additionalProperties": false
  }
}
