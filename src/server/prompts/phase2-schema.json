{
  "type": "json_schema",
  "schema": {
    "type": "object",
    "properties": {
      "valueFlows": {
        "type": "array",
        "description": "How BCH and tokens move through the system",
        "items": {
          "type": "object",
          "properties": {
            "asset": { "type": "string", "description": "BCH or token name" },
            "path": { "type": "string", "description": "Flow path like 'User -> LoanContract -> StabilityPool'" },
            "trigger": { "type": "string", "description": "What triggers this flow" }
          },
          "required": ["asset", "path", "trigger"],
          "additionalProperties": false
        }
      },
      "patterns": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "appliedTo": { "type": "string" },
            "rationale": { "type": "string" }
          },
          "required": ["name", "appliedTo", "rationale"],
          "additionalProperties": false
        }
      },
      "custodyDecisions": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "entity": { "type": "string" },
            "custody": { "type": "string" },
            "contractName": { "type": "string", "description": "Required if custody=contract" },
            "rationale": { "type": "string" },
            "ownerFieldInCommitment": { "type": "string", "description": "How owner is tracked if contract custody" }
          },
          "required": ["entity", "custody", "rationale"],
          "additionalProperties": false
        }
      },
      "tokenCategories": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "id": { "type": "string" },
            "purpose": { "type": "string" },
            "capability": { "type": "string" },
            "typeDiscriminator": { "type": "string", "description": "First-byte mapping to contract types, format: '0x01=TypeA, 0x02=TypeB'" }
          },
          "required": ["id", "purpose", "capability"],
          "additionalProperties": false
        }
      },
      "contracts": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "Must end with 'Contract'" },
            "role": { "type": "string" },
            "lifecycle": { "type": "string" },
            "tokenCategory": { "type": "string" },
            "capability": { "type": "string" },
            "typeIdentifier": { "type": "string", "description": "First byte of commitment for type discrimination" },
            "validates": { "type": "string", "description": "CONCRETE validation rules - if none, DO NOT include this contract" },
            "sidecar": { "type": "string", "description": "For role=container: name of sidecar contract" },
            "delegatesTo": { "type": "array", "items": { "type": "string" }, "description": "For role=container: function contracts it delegates to" },
            "attachedTo": { "type": "string", "description": "For role=sidecar: container it's attached to" },
            "indexOffset": { "type": "integer", "description": "For role=sidecar: output index offset from container" },
            "functionId": { "type": "string", "description": "For role=function: byte identifier" },
            "inputIndex": { "type": "integer", "description": "For role=function: expected input index" },
            "mintingProtection": { "type": "string", "description": "For contracts with minting NFTs" },
            "stateLayout": { "type": "string", "description": "State fields layout (max 128 bytes)" }
          },
          "required": ["name", "role", "lifecycle", "validates"],
          "additionalProperties": false
        }
      },
      "transactionTemplates": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "purpose": { "type": "string" },
            "inputs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "index": { "type": "integer" },
                  "contract": { "type": "string", "description": "Contract name or omit for P2PKH" },
                  "from": { "type": "string", "description": "Use 'P2PKH' or 'User' for user inputs" },
                  "type": { "type": "string" }
                },
                "required": ["index", "type"],
                "additionalProperties": false
              }
            },
            "outputs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "index": { "type": "integer" },
                  "contract": { "type": "string", "description": "Contract name or omit for P2PKH" },
                  "to": { "type": "string", "description": "Use 'P2PKH' or 'User' for user outputs" },
                  "type": { "type": "string" },
                  "stateChanges": { "type": "string", "description": "Which state fields change, comma-separated" }
                },
                "required": ["index", "type"],
                "additionalProperties": false
              }
            }
          },
          "required": ["name", "purpose", "inputs", "outputs"],
          "additionalProperties": false
        }
      },
      "invariantEnforcement": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "invariant": { "type": "string" },
            "enforcedBy": { "type": "string" },
            "mechanism": { "type": "string" }
          },
          "required": ["invariant", "enforcedBy", "mechanism"],
          "additionalProperties": false
        }
      },
      "warnings": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "severity": { "type": "string" },
            "issue": { "type": "string" },
            "mitigation": { "type": "string" }
          },
          "required": ["severity", "issue", "mitigation"],
          "additionalProperties": false
        }
      }
    },
    "required": ["valueFlows", "patterns", "custodyDecisions", "tokenCategories", "contracts", "transactionTemplates", "invariantEnforcement", "warnings"],
    "additionalProperties": false
  }
}
