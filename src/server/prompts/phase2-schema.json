{
  "valueFlows": [{
    "asset": "BCH|tokenName",
    "path": "User -> LoanContract -> StabilityPool",
    "trigger": "liquidation"
  }],

  "patterns": [{
    "name": "container-function|main-sidecar|strict-position|origin-proof",
    "appliedTo": "LoanContract",
    "rationale": "Why this pattern was chosen"
  }],

  "custodyDecisions": [{
    "entity": "Voter",
    "custody": "contract|p2pkh",
    "contractName": "VoterContract",
    "rationale": "Must enforce voting rules - can't vote twice",
    "ownerFieldInCommitment": "ownerPkh (bytes20)"
  }],

  "tokenCategories": [{
    "id": "system",
    "purpose": "Main system tokens",
    "capability": "minting|mutable|immutable",
    "typeDiscriminator": {
      "0x00": "PriceContract",
      "0x01": "LoanContract",
      "0x02": "ManageFunction"
    }
  }],

  "contracts": [{
    "name": "LoanContract",
    "role": "container|function|sidecar|minting|independent",
    "lifecycle": "exactly-replicating|state-mutating|state-and-balance-mutating|conditionally-replicating",
    "tokenCategory": "system",
    "capability": "mutable",
    "typeIdentifier": "0x01",
    "validates": "CONCRETE rules - if none, DO NOT include this contract",

    "__comment_container": "Fields below are for role=container only",
    "sidecar": "LoanSidecarContract",
    "delegatesTo": ["ManageFunction", "LiquidateFunction"],

    "__comment_sidecar": "Fields below are for role=sidecar only",
    "attachedTo": "LoanContract",
    "indexOffset": 1,

    "__comment_function": "Fields below are for role=function only",
    "functionId": "0x02",
    "inputIndex": 3,

    "__comment_minting": "Fields below are for contracts with minting NFTs",
    "mintingProtection": {
      "maxOutputs": 6,
      "validatedOutputs": "All outputs 0-5 have tokenCategory checked",
      "unknownOutputsRestricted": true
    },

    "stateLayout": {
      "totalBytes": 27,
      "fields": [
        { "name": "identifier", "type": "bytes1", "fixed": "0x01" },
        { "name": "borrowedAmount", "type": "bytes6" },
        { "name": "ownerPkh", "type": "bytes20" }
      ]
    }
  }],

  "transactionTemplates": [{
    "name": "manageLoan",
    "purpose": "Repay debt or adjust collateral",
    "inputs": [
      { "index": 0, "contract": "PriceContract", "type": "state-nft" },
      { "index": 1, "contract": "LoanContract", "type": "state-nft" },
      { "index": 2, "contract": "LoanSidecarContract", "type": "sidecar" },
      { "index": 3, "contract": "ManageFunction", "type": "function-nft" },
      { "index": 4, "from": "P2PKH", "type": "auth-bch" }
    ],
    "outputs": [
      { "index": 0, "contract": "PriceContract", "type": "state-nft" },
      { "index": 1, "contract": "LoanContract", "type": "state-nft", "stateChanges": ["borrowedAmount"] },
      { "index": 2, "contract": "LoanSidecarContract", "type": "sidecar" },
      { "index": 3, "contract": "ManageFunction", "type": "function-nft" }
    ]
  }],

  "invariantEnforcement": [{
    "invariant": "Total supply never exceeds cap",
    "enforcedBy": "MintingContract",
    "mechanism": "Validates tokenAmount in outputs"
  }],

  "warnings": [{
    "severity": "critical|high|medium",
    "issue": "Description of potential problem",
    "mitigation": "How to address it"
  }]
}
